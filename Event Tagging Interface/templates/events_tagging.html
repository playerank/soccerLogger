<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="{{ url_for('static', filename='gamecontroller.js-1.5.0/dist/gamecontroller.min.js') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='material-design-icons-master/css/material-icons.css') }}">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href="{{ url_for('static', filename='css/table_scroll.css') }}" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
    <script src="./static/gamecontroller.js-1.5.0/dist/gamecontroller.min.js"></script>

    <script> 
      gameControl
        .on('connect', gamepad => {
          var last_button = ''
          var last_event_button = ''
          var current_event_page = 0

          gamepad.on('button4', () => {
            $('#prev-frame').trigger("click")
          });
          gamepad.on('button5', () => {
            $('#next-frame').trigger("click")
          });
          gamepad.on('button0', () => {
            if (last_button != 'button0') {
              $('#new-event').trigger("click")
              last_button = 'button0'
              window.setTimeout(function(){last_button=''}, 300)
            }
          });
          gamepad.on('button3', () => {
            if (last_button != 'button3') {
              $('#event-start').trigger("click")
              last_button = 'button3'
              window.setTimeout(function(){last_button=''}, 300)
            }
          });
          gamepad.on('button1', () => {
            if (last_button != 'button1') {
              $('#event-end').trigger("click")
              last_button = 'button1'
              window.setTimeout(function(){last_button=''}, 300)
            }
          }); 
          gamepad.on('button2', () => {
            if (last_button != 'button2') {
              $('#start-pause').trigger("click")
              last_button = 'button2'
              window.setTimeout(function(){last_button=''}, 300)
            }
          }); 

         });

    </script>

    <script type="text/javascript">

      jQuery(document).ready(function($) {
 
          var url = window.location.href
          if (url.includes("Pass")){
            $("#pass-events").attr('checked', true);
          }
          else if (url.includes("Shot")){
            $("#shot-events").attr('checked', true);
          }
          else{
            $("#goal-events").attr('checked', true);
          } 

         $(window).keydown(function(event) {
            if(event.which == 87) {  //w
                $('#start-pause').trigger("click")
              event.preventDefault();
            }
            if(event.which == 69) {  //e
                $('#next-frame').trigger("click")
              event.preventDefault();
            }
            if(event.which == 81) {  //q
                $('#prev-frame').trigger("click")
              event.preventDefault();
            }
            if(event.which == 79) {  //o
                $('#event-start').trigger("click")
              event.preventDefault();
            }
            if(event.which == 80) {  //p
                $('#event-end').trigger("click")
              event.preventDefault();
            }
            if(event.which == 76) {  //l
                $('#new-event').trigger("click")
              event.preventDefault();
            }
          });

         $('#myTable').DataTable( {
          scrollX: false,
          scrollCollapse: true,
          paging: false,
          searching: false,
          info: false,
          language: { 
            emptyTable: null,
            infoEmpty: null,
            zeroRecords: null
            /*searchPanes: {
              emptyPanes: null
            }*/
          },
          select: 'single'
         }); 

         $('#myTable').on( 'click', 'tbody tr', function () {     
           var time = $( this ).find('td:nth-child(2)').text();
           var vid = document.getElementById("myVideo");
           vid.currentTime = time 
         });

         $("#next-frame").click(function() {
           var vid = document.getElementById("myVideo");
           vid.pause();
           vid.currentTime = Math.min(vid.duration, vid.currentTime + 0.04);
         });

         $("#prev-frame").click(function() {
           var vid = document.getElementById("myVideo");
           vid.pause();
           vid.currentTime = Math.min(vid.duration, vid.currentTime - 0.04);
         });

         $("#start-pause").click(function() {
           var vid = document.getElementById("myVideo");
           if (vid.paused) {
             vid.play();
             $(this).html('<i class="mdi mdi-pause"></i>')
           } else {
             vid.pause();
             $(this).html('<i class="mdi mdi-play-arrow mdi-lg"></i>')
           }
         });  

         $("#event-start").click(function() {
           var vid = document.getElementById("myVideo");
           var time_start = (Math.round( vid.currentTime * 100) / 100)
           $("#val-1").val(time_start)
         });

         $("#event-end").click(function() {
           var vid = document.getElementById("myVideo");
           vid.pause();
           var time_start = (Math.round( vid.currentTime * 100) / 100)
           $("#val-2").val(time_start)

         });

         var csv_is_new = true
         var first_row_number = $('#myTable tbody tr:first').find('td:nth-child(1)').text()
         if(first_row_number == 1){
          csv_is_new = false
         }

         $("#new-event").click(function() {
           
          if(first_row_number == 1){
            var current_event_number = $('#myTable tr').length
          }
          else{
            var current_event_number = $('#myTable tr').length - 1
          }
          var value1 = $("#val-1").val()
          var value2 = $("#val-2").val()
          var myTab = document.getElementById("myTable")
          var row = myTab.insertRow(current_event_number) 
  
          var td0 = row.insertCell(0)
          var td1 = row.insertCell(1)
          var td2 = row.insertCell(2)
          var node0 = document.createTextNode(current_event_number)
          var node1 = document.createTextNode(value1)
          var node2 = document.createTextNode(value2) 
          td0.appendChild(node0)
          td1.appendChild(node1)
          td2.appendChild(node2)
         });  

         $("#update-csv").click(function() {

            var table_matrix = new Array()
            $('#myTable tr').each(function(){
                var row_list = ""
                var firstLine = true
                $(this).find('td').each(function(){
                  if (firstLine) {
                    row_list += $(this).text()
                    firstLine = false
                  }
                  else {
                    row_list += ";" + $(this).text()
                  }
                })
                table_matrix.push(row_list)
            })  
            if(csv_is_new){
              table_matrix.pop(-1)
            }
            
            $.ajax({
             type: "POST",
             data: JSON.stringify({table:table_matrix}),
             url: "/{{match}}/update",
             contentType: "application/json; charset=utf-8",
             success: function(dat) { console.log(dat);}
            });

            $.ajax({
              url: '/{{match}}',
              success: function() {
                  window.location.reload();
              }
            });

         }); 

      });
    </script>
  </head>
  
  <body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-md-2">
      <span class="navbar-brand mb-2 mt-2 display2 ">Events Tagging Dashboard</span>

      <div class="collapse navbar-collapse ml-5" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Matches
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
              {% for v in (dropdown) %}
                 <a class="dropdown-item" href= "/{{ v[1] }}" >{{ v[0] }}</a>
              {% endfor %}
            </div>
          </li>
        </ul>

      </div>
    </nav>

      <div class="container-fluid p-4 bg-light text-dark">

        <div class="row">
          <div class="col-7">
            <h2 class="text-center">{{ match_name }}</h2>
          </div>
          <div class="col-5">
            <div class="row border border-secondary rounded-top">
              <div class="col-md-3 p-3">
                <button type="button" class="btn btn-warning btn-md" id="update-csv"><i class="mdi mdi-file-upload mdi-lg"></i> Update CSV</button>
              </div>
              <div class="col-md-8 text-center p-3">
                <h4 class="text-dark"><strong>Last Update: {{date_last_update}}</strong></h4> 
              </div>
            </div>
          </div>
        </div>

        <div class="row">

          <video class="col-lg-7" src="{{ video_link }}" controls id="myVideo"></video>
          <div class="mh-100 col-lg-5 border border-secondary rounded-bottom p-0" style="overflow-y:auto;" id="table_div">  
            <table class="table table-scroll table-hover" id="myTable">
              <thead class="thead-dark fixed_header">
                <tr>
                  {% for header_val in (data[0]) %}
                    <th scope="col">{{header_val}}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>

                {% set rows = [] %}
                {% for row in (data[1:]) %}
                  {% if rows|length < 1 %}
                    <tr>
                      {% for val in (row) %}
                        {% if (val != '0' and (loop.index0 == 2 or loop.index0 == 3)) %}
                          <td>{{val}}</td>
                        {% else %}
                          <td>{{val}}</td>
                        {% endif %}
                      {% endfor %}
                    </tr>
                    {% if rows.append(1) %}{% endif %}
                  {% else %}
                    <tr>
                      {% for val in (row) %}
                        {% if (val != '0' and (loop.index0 == 2 or loop.index0 == 3)) %}
                          <td>{{val}}</td>
                        {% else %}
                          <td>{{val}}</td>
                        {% endif %}
                      {% endfor %}
                    </tr>
                  {% endif %}
                {% endfor %}
              </tbody>
            </table>
          </div>

        </div>

        <div class="row">
          <div class="col-lg-7">

            <div class="row border border-secondary rounded-top mt-3">
              <div class="col p-3 text-center">
                <button type="button" class="btn btn-dark btn-md btn-block" id="prev-frame"><i class="mdi mdi-skip-previous mdi-lg"></i></button>
              </div>
              <div class="col p-3 text-center">
                <button type="button" class="btn btn-danger btn-md btn-block" id="start-pause"><i class="mdi mdi-play-arrow mdi-lg"></i></button>
              </div>
              <div class="col p-3 text-center">
                <button type="button" class="btn btn-dark btn-md btn-block" id="next-frame"><i class="mdi mdi-skip-next mdi-lg"></i></button>
              </div>
            </div>

          </div>
          <div class="col-lg-5">
            <div class="row">
              <div class="col-md-4 p-3 text-center">
                <div class="radio">
                  <h4 class="text-dark"><strong>Events Type:</strong></h4>
                </div>
              </div>
              <div class="col-2 p-3 text-center">
                <div class="radio">
                  <label><input type="radio" onclick="window.location='/{{match_code + '_Pass'}}';" name="optradio" id="pass-events" >Pass</label>
                </div>
              </div>
              <div class="col-2 p-3 text-center">
                <div class="radio">
                  <label><input type="radio" onclick="window.location='/{{match_code + '_Shot'}}';" name="optradio" id="shot-events">Shot</label>
                </div>
              </div>
              <div class="col-2 p-3 text-center">
                <div class="radio">
                  <label><input type="radio" onclick="window.location='/{{match_code + '_Goal'}}';" name="optradio" id="goal-events">Goal</label>
                </div>
              </div>

            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-lg-7">

            <div class="row pt-2 border border-secondary rounded-bottom">
              <div class="col p-3 text-center">
                <button type="button" class="btn btn-primary btn-md btn-block" id="event-start"> <i class="mdi mdi-watch-later mdi-lg"></i> Event Start</button>
              </div>
              <div class="col p-3 text-center">
                <button type="button" class="btn btn-success btn-md btn-block" id="event-end"> <i class="mdi mdi-watch-later mdi-lg"></i> Event End</button>
              </div>
            </div>
          </div>

          <div class="col-lg-5 float-right">
            <input type="number" id="val-1" value="0">
            <input type="number" id="val-2" value="0">
            <button type="button" id="new-event">Add Event</button>
          </div>

          
        </div>
      </div>
  </body>
</html>
